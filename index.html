<!DOCTYPE html>
<html lang="en" class="dark:bg-darkBg antialiased">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>High CPM Multi-Tab Browser</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            darkBg: '#111827',
            darkText: '#f3f4f6',
            darkCard: '#1f2937',
            darkBorder: '#374151',
            cpmGold: '#f59e0b'
          }
        }
      }
    };
  </script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s, color 0.3s;
    }

    .window-container {
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
      transition: transform 0.1s;
    }

    .dark .window-container {
      border-color: #374151;
    }

    .tab-header {
      display: flex;
      background: #f3f4f6;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .dark .tab-header {
      background: #374151;
      border-bottom-color: #4b5563;
    }

    .tab-header::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.875rem;
      white-space: nowrap;
      position: relative;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-right: 1px solid #e5e7eb;
    }

    .dark .tab {
      border-right-color: #4b5563;
      color: #f3f4f6;
    }

    .tab.active {
      @apply bg-white dark:bg-darkCard font-medium;
      border-bottom: 3px solid #3b82f6;
      margin-bottom: -1px;
    }

    .tab .close-btn {
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      border-radius: 50%;
      font-size: 10px;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .tab:hover .close-btn {
      opacity: 1;
    }

    .tab .close-btn:hover {
      background: #ef4444;
      color: white;
    }

    .iframe-container {
      position: relative;
      height: 400px;
      background: #fff;
    }

    .dark .iframe-container {
      background: #1f2937;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: 0.5rem;
    }

    .stats-bar {
      background: #f1f5f9;
      border-top: 1px solid #d1d5db;
      padding: 0.5rem;
      font-size: 0.875rem;
      color: #4b5563;
    }

    .dark .stats-bar {
      background: #374151;
      border-top-color: #4b5563;
      color: #d1d5db;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 dark:bg-darkBg dark:text-darkText transition-colors duration-300">
  <div class="container max-w-7xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
      <h1 class="text-2xl sm:text-3xl font-bold text-primary flex items-center gap-2">
        üí∞ High CPM Multi-Tab Browser
      </h1>
      <button id="dark-mode-toggle"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg shadow hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary transition">
        Toggle Dark Mode
      </button>
    </header>

    <!-- CPM Controls -->
    <div class="bg-white dark:bg-darkCard p-4 rounded-lg shadow mb-6 border border-gray-200 dark:border-darkBorder">
      <h2 class="font-semibold mb-3 text-lg">üéØ CPM Optimization Settings</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium mb-1">URL or Site List</label>
          <textarea id="site-input" rows="2"
            class="w-full p-2 border border-gray-300 dark:border-darkBorder rounded text-sm bg-white dark:bg-darkCard"
            placeholder="https://news-site.com&#10;https://viral-blog.com&#10;https://example-adsite.com">https://www.bbc.com&#10;https://edition.cnn.com&#10;https://www.nytimes.com</textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Auto Refresh (sec)</label>
          <input type="number" id="refresh-interval" value="30" min="10"
            class="w-full p-2 border border-gray-300 dark:border-darkBorder rounded bg-white dark:bg-darkCard" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Windows per Site</label>
          <input type="number" id="windows-per-site" value="2" min="1" max="10"
            class="w-full p-2 border border-gray-300 dark:border-darkBorder rounded bg-white dark:bg-darkCard" />
        </div>
        <div class="flex items-end">
          <button id="launch-cpm-button"
            class="w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-medium transition">
            Launch CPM Mode
          </button>
        </div>
      </div>
      <div class="text-xs text-gray-500 dark:text-gray-400">
        üí° Tip: Use ad-heavy, high-traffic sites (news, blogs) for best CPM.
      </div>
    </div>

    <div id="message-box"
      class="hidden p-4 mb-6 text-center font-medium rounded-lg border border-transparent transition-all duration-300"></div>

    <div id="window-grid"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 auto-rows-fr"></div>

    <div class="mt-4 text-center text-sm text-gray-500 dark:text-gray-400">
      <div id="impression-counter">Total Impressions: 0</div>
      <div id="active-windows">Active Windows: 0</div>
    </div>
  </div>

  <script>
    // DOM Elements
    const siteInput = document.getElementById('site-input');
    const refreshIntervalInput = document.getElementById('refresh-interval');
    const windowsPerSiteInput = document.getElementById('windows-per-site');
    const launchCpmButton = document.getElementById('launch-cpm-button');
    const windowGrid = document.getElementById('window-grid');
    const messageBox = document.getElementById('message-box');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const impressionCounter = document.getElementById('impression-counter');
    const activeWindowsDisplay = document.getElementById('active-windows');

    // State
    let nextWindowId = 1;
    let nextTabId = 1;
    let totalImpressions = 0;
    let activeWindows = 0;
    let refreshIntervals = {}; // Store interval IDs per window

    // Load saved state
    window.addEventListener('load', () => {
      siteInput.value = localStorage.getItem('cpmSites') || `https://www.bbc.com\nhttps://edition.cnn.com\nhttps://www.nytimes.com`;
      refreshIntervalInput.value = localStorage.getItem('refreshInterval') || '30';
      windowsPerSiteInput.value = localStorage.getItem('windowsPerSite') || '2';
      if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
      }
    });

    // Save on change
    siteInput.addEventListener('input', () => localStorage.setItem('cpmSites', siteInput.value));
    refreshIntervalInput.addEventListener('input', () => localStorage.setItem('refreshInterval', refreshIntervalInput.value));
    windowsPerSiteInput.addEventListener('input', () => localStorage.setItem('windowsPerSite', windowsPerSiteInput.value));

    function showMessage(message, type = 'success') {
      messageBox.textContent = message;
      messageBox.className = `p-4 mb-6 text-center font-medium rounded-lg transition ${
        type === 'success'
          ? 'bg-green-100 text-green-700 border border-green-400 dark:bg-green-200 dark:text-green-900'
          : 'bg-red-100 text-red-700 border border-red-400 dark:bg-red-200 dark:text-red-900'
      }`;
      messageBox.classList.remove('hidden');
      setTimeout(() => {
        messageBox.classList.add('opacity-0');
        setTimeout(() => messageBox.classList.add('hidden'), 300);
      }, 3000);
    }

    function sanitizeUrl(url) {
      try {
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          url = 'https://' + url;
        }
        return new URL(url).href;
      } catch (e) {
        return null;
      }
    }

    function createTab(windowId, url, title = 'New Tab', isActive = false) {
      const tabId = `tab-${nextTabId++}`;
      const tab = document.createElement('div');
      tab.className = `tab ${isActive ? 'active' : ''}`;
      tab.dataset.tabId = tabId;
      tab.dataset.url = url;
      tab.innerHTML = `
        <span class="truncate max-w-[120px]">${title}</span>
        <span class="close-btn">√ó</span>
      `;

      tab.addEventListener('click', (e) => {
        if (e.target.classList.contains('close-btn')) {
          e.stopPropagation();
          closeTab(tab, windowId);
          return;
        }
        activateTab(tab, windowId);
      });

      return { tab, tabId };
    }

    function activateTab(tabElement, windowId) {
      const container = document.getElementById(`window-${windowId}`);
      const tabs = container.querySelectorAll('.tab');
      const iframes = container.querySelectorAll('iframe');

      tabs.forEach(t => t.classList.remove('active'));
      iframes.forEach(f => f.classList.add('hidden'));

      tabElement.classList.add('active');
      const iframe = document.getElementById(`iframe-${windowId}-${tabElement.dataset.tabId}`);
      if (iframe) iframe.classList.remove('hidden');
    }

    function closeTab(tabElement, windowId) {
      const container = document.getElementById(`window-${windowId}`);
      const iframe = document.getElementById(`iframe-${windowId}-${tabElement.dataset.tabId}`);
      const isActive = tabElement.classList.contains('active');

      tabElement.remove();
      iframe?.remove();

      // Clear interval if last tab
      if (container && container.querySelectorAll('.tab').length === 0) {
        clearInterval(refreshIntervals[windowId]);
        delete refreshIntervals[windowId];
        container.remove();
        activeWindows--;
        updateWindowStats();
      }

      if (isActive && container && container.querySelector('.tab')) {
        const firstTab = container.querySelector('.tab');
        firstTab.classList.add('active');
        const firstIframe = document.getElementById(`iframe-${windowId}-${firstTab.dataset.tabId}`);
        firstIframe?.classList.remove('hidden');
      }
    }

    function createIframe(windowId, tabId, url) {
      const iframe = document.createElement('iframe');
      iframe.id = `iframe-${windowId}-${tabId}`;
      iframe.src = url;
      iframe.sandbox = "allow-same-origin allow-scripts allow-popups allow-forms";
      iframe.allow = "accelerometer; camera; fullscreen; geolocation; microphone; clipboard-read; clipboard-write";
      iframe.loading = "lazy";
      iframe.className = 'w-full h-full border-0';
      iframe.style.display = 'none';

      const loader = document.createElement('div');
      loader.className = 'loading-overlay';
      loader.innerHTML = `
        <div class="text-center">
          <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent"></div>
          <p class="mt-2">Loading...</p>
        </div>
      `;

      const container = document.createElement('div');
      container.className = 'iframe-container relative';
      container.appendChild(iframe);
      container.appendChild(loader);

      // Simulate scroll after load (for ad viewability)
      iframe.onload = () => {
        loader.remove();
        iframe.classList.remove('hidden');
        setTimeout(() => {
          try {
            const win = iframe.contentWindow;
            win.scrollTo(0, win.document.body.scrollHeight * 0.3);
            setTimeout(() => win.scrollTo(0, win.document.body.scrollHeight * 0.6), 1000);
          } catch (e) {
            console.warn("Cannot scroll iframe (cross-origin):", e);
          }
        }, 2000);
      };

      return container;
    }

    function openWindowForUrl(url, windowId) {
      const container = document.createElement('div');
      container.id = `window-${windowId}`;
      container.className = 'window-container bg-white dark:bg-darkCard border border-gray-200 dark:border-darkBorder rounded-lg shadow overflow-hidden';

      const tabHeader = document.createElement('div');
      tabHeader.className = 'tab-header';

      const title = new URL(url).hostname;
      const { tab, tabId } = createTab(windowId, url, title, true);
      tabHeader.appendChild(tab);

      const iframeContainer = createIframe(windowId, tabId, url);
      container.appendChild(tabHeader);
      container.appendChild(iframeContainer);

      // Add stats bar
      const statsBar = document.createElement('div');
      statsBar.className = 'stats-bar text-xs';
      statsBar.innerHTML = `üåê <b>${title}</b> | üîÑ Auto-refresh: ${refreshIntervalInput.value}s`;
      container.appendChild(statsBar);

      windowGrid.appendChild(container);

      // Auto-refresh logic
      const interval = setInterval(() => {
        const iframe = document.getElementById(`iframe-${windowId}-${tabId}`);
        if (iframe) {
          iframe.src = iframe.src; // Reload
          totalImpressions++;
          updateImpressionCounter();
        }
      }, parseInt(refreshIntervalInput.value) * 1000);

      refreshIntervals[windowId] = interval;
      activeWindows++;
      updateWindowStats();
    }

    function launchCpmMode() {
      const sites = siteInput.value.trim().split('\n').map(s => s.trim()).filter(Boolean);
      const windowsPerSite = parseInt(windowsPerSiteInput.value);
      const interval = parseInt(refreshIntervalInput.value);

      if (sites.length === 0 || windowsPerSite <= 0 || interval < 10) {
        showMessage("Please enter valid sites and settings.", "error");
        return;
      }

      // Close all before starting
      closeAllWindows();

      sites.forEach(site => {
        const url = sanitizeUrl(site);
        if (!url) {
          showMessage(`Invalid URL: ${site}`, "error");
          return;
        }
        for (let i = 0; i < windowsPerSite; i++) {
          openWindowForUrl(url, nextWindowId++);
        }
      });

      showMessage(`Launched ${sites.length * windowsPerSite} windows for CPM optimization!`, "success");
    }

    function closeAllWindows() {
      Object.values(refreshIntervals).forEach(clearInterval);
      refreshIntervals = {};
      document.querySelectorAll('.window-container').forEach(el => el.remove());
      activeWindows = 0;
      updateWindowStats();
    }

    function updateImpressionCounter() {
      impressionCounter.textContent = `Total Impressions: ${totalImpressions}`;
    }

    function updateWindowStats() {
      activeWindowsDisplay.textContent = `Active Windows: ${activeWindows}`;
    }

    launchCpmButton.addEventListener('click', launchCpmMode);

    darkModeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      darkModeToggle.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    });
  </script>
</body>

</html>
